import"./imagesloaded-CyESsmFl.js";console.log("Gallery view ready");const M=window.APP_CONFIG?.apiBase||"/gallery/api",ee=8,v=8,F=[320,2048],D=12,H=2,S=2,i=(e,t=document)=>t.querySelector(e);function te(e,t){const o=new URL(e,location.origin);return Object.entries(t).forEach(([l,n])=>{n!=null&&n!==""&&o.searchParams.set(l,n)}),o.toString()}function ne(e,t=4/3){if(!e)return t;if(typeof e=="number")return e;const o=String(e).match(/^(\d+(?:\.\d+)?)\/(\d+(?:\.\d+)?)$/);if(!o)return t;const l=parseFloat(o[1]),n=parseFloat(o[2]);return n>0?l/n:t}function j(){const e=getComputedStyle(document.documentElement),t=parseFloat(e.getPropertyValue("--rowH")||"220");return Math.max(120,Math.min(320,t))}function oe(){const e=j();return`${Math.round(H*e+Math.max(0,H-1)*v)}px 0px`}let c=[],b=null,p=0,h=0,m=[],g=null,w=null,a=null,O=!1,T=!1,I=!1,W=!1;const re=180;let P=0;async function ie(e,t,o){const l=new URL(`${M}/${encodeURIComponent(e)}`,location.origin);l.searchParams.set("store",t);const n=await fetch(l.toString(),{headers:{Accept:"application/json"}});if(!n.ok)throw new Error(`Fetch ${n.status}`);return n.json()}function le(){W||(W=!0,setTimeout(()=>{W=!1,N()},re))}function N(){if(!O){O=!0;try{const e=i("#grid"),t=Math.floor(e.clientWidth||0);if(!t)return;if(P=t,h>=c.length&&m.length===0){g&&a&&g.unobserve(a);return}const o=j();let l=0,n=[...m];for(m=[];h<c.length||n.length;){let r=[],d=0;for(;n.length;){const s=n.shift();r.push(s),d+=s.aspect}for(;h<c.length;){const s=c[h],y=ne(s.aspectRatio,4/3);if(r.push({idx:h,img:s,aspect:y}),d+=y,h++,d*o+v*(r.length-1)>=t*.98||r.length>=12)break}if(!r.length)break;let u=o,f=!1;const E=h<c.length,R=d*o+v*(r.length-1);if(!f&&R<t*.7&&r.length>=6&&E){const s=(t-v*(r.length-1))/(d*o);u=Math.max(120,Math.min(360,Math.round(o*s))),f=!0}if(E&&!f&&R!==t){const s=(t-v*(r.length-1))/(d*o);u=Math.max(120,Math.min(360,Math.round(o*s))),f=!0}const x=document.createElement("div");x.className="jg-row",x.style.height=`${u}px`;let k=r.map(s=>Math.round(s.aspect*u)),K=k.reduce((s,y)=>s+y,0)+v*(r.length-1),$=t-K;if(f&&Math.abs($)<=r.length*2)for(let s=0;$!==0&&s<k.length;s++)k[s]+=$>0?1:-1,$+=$>0?-1:1;if(r.forEach((s,y)=>{const U=k[y],J=u,L=document.createElement("figure");L.className="jg-item",L.style.width=`${U}px`,L.style.height=`${J}px`;const Q=`${M}/file?store=${encodeURIComponent(b.store||"public")}&album=${encodeURIComponent(b.id)}&f=${encodeURIComponent(s.img.filename)}`,A=te(Q,{w:F[0],q:100}),B=`${U}px`,Y=`${b.title||""} - ${s.img.filename||""}`.trim().replace(/"/g,"&quot;");L.innerHTML=`
          <picture>
            <source type="image/webp" srcset="${A} 320w" sizes="${B}">
            <img
              data-index="${s.idx}"
              src="${A}"
              srcset="${A} 320w"
              sizes="${B}"
              alt="${Y}"
              loading="${s.idx<D?"eager":"lazy"}"
              decoding="async"
              fetchpriority="${s.idx<D?"high":"low"}"
            />
          </picture>
        `,L.querySelector("img").addEventListener("click",Z=>{p=Number(Z.currentTarget.dataset.index||0),X(p,b)}),x.appendChild(L)}),i("#grid").appendChild(x),l++,l>=ee)break;if(!f&&h<c.length){m=r.map(s=>({...s}));break}else m=[]}g&&a&&h>=c.length&&m.length===0&&g.unobserve(a)}finally{O=!1}}}function q(){a||(a=document.createElement("div"),a.id="sentinel",a.className="h-8",i("#grid").after(a),g=new IntersectionObserver(e=>{e.some(t=>t.isIntersecting)&&le()},{rootMargin:oe()}),g.observe(a))}function se(e){i("#album-title").textContent=e.title??"(Untitled)";const t=i("#grid");if(t.innerHTML="",!e.images||e.images.length===0){i("#empty").classList.remove("hidden");return}i("#empty").classList.add("hidden"),c=e.images,b=e,h=0,m=[],N(),q(),i("#lb-download")?.addEventListener("click",async l=>{l.preventDefault();try{await ae(b,p)}catch(n){console.error(n)}})}function z(e,t){const o=c[t];return o?`${M}/raw?store=${encodeURIComponent(e.store||"public")}&album=${encodeURIComponent(e.id)}&f=${encodeURIComponent(o.filename)}`:""}function G(e,t){const o=c[t];return o?`${M}/file?store=${encodeURIComponent(e.store||"public")}&album=${encodeURIComponent(e.id)}&f=${encodeURIComponent(o.filename)}&w=${F[1]}&q=80`:""}function X(e,t){const o=G(t,e),l=i("#lb-img");l&&(l.src=o);const n=i("#lb-download");n&&(n.href=z(t,e),n.setAttribute("download",c[e]?.filename||"photo")),i("#lightbox").classList.remove("hidden"),document.body.style.overflow="hidden",ce(e,t)}function _(){i("#lightbox").classList.add("hidden");const e=i("#lb-img");e&&(e.src=""),document.body.style.overflow=""}function C(e,t){c.length&&(p=(p+e+c.length)%c.length,X(p,t))}function ce(e,t){if(!(!Number.isInteger(S)||S<=0))for(let o=1;o<=S;o++){const l=(e+o+c.length)%c.length,n=(e-o+c.length)%c.length;[l,n].forEach(r=>{const d=G(t,r),u=new Image;u.decoding="async",u.loading="eager",u.referrerPolicy="no-referrer-when-downgrade",u.src=d})}}async function ae(e,t){const o=z(e,t);if(!o)return;const l=await fetch(o,{method:"GET"});if(!l.ok)throw new Error(`Download failed: ${l.status}`);const n=l.headers.get("Content-Type")||"application/octet-stream",r=await l.blob(),d=(c[t]?.filename||"photo").replace(/[^\w.\- ()[\]]+/g,"_"),u=new File([r],d,{type:n});if(navigator.canShare&&navigator.canShare({files:[u]})&&navigator.share)try{await navigator.share({files:[u],title:e.title||d,text:""});return}catch(R){console.warn("Share failed, fallback to download:",R)}const f=document.createElement("a"),E=URL.createObjectURL(r);f.href=E,f.download=d,document.body.appendChild(f),f.click(),f.remove(),setTimeout(()=>URL.revokeObjectURL(E),2e3)}function V(){T||(T=!0,setTimeout(()=>{T=!1,I=!0;try{w&&w.disconnect(),g&&a&&g.unobserve(a);const e=p;if(!b)return;const o=i("#grid");o.innerHTML="",h=0,m=[],N(),p=e,w||(w=new ResizeObserver(()=>{if(I)return;const l=Math.floor(i("#grid").clientWidth||0);!l||Math.abs(l-P)<4||V()})),w.observe(i("#grid")),a&&g&&g.observe(a)}finally{I=!1}},120))}(function(){i("#mobile-menu-btn")?.addEventListener("click",()=>{const n=i("#mobile-menu");n&&n.classList.toggle("hidden")});const t=location.pathname.replace(/\/+$/,"").split("/"),o=t[t.length-1]||"",l="public";if(!o){i("#error")?.classList.remove("hidden"),i("#error-detail").textContent="ไม่พบค่า id จาก URL";return}ie(o,l).then(n=>{if(!n?.ok)throw new Error("API return not ok");se(n),i("#lb-close")?.addEventListener("click",_),i("#lb-prev")?.addEventListener("click",()=>C(-1,n)),i("#lb-next")?.addEventListener("click",()=>C(1,n)),i("#lightbox")?.addEventListener("click",r=>{r.target===r.currentTarget&&_()}),window.addEventListener("keydown",r=>{i("#lightbox").classList.contains("hidden")||(r.key==="Escape"&&_(),r.key==="ArrowRight"&&C(1,n),r.key==="ArrowLeft"&&C(-1,n),r.key.toLowerCase()==="d"&&i("#lb-download")?.click())}),w=new ResizeObserver(()=>{if(I)return;const r=Math.floor(i("#grid").clientWidth||0);!r||Math.abs(r-P)<4||V()}),w.observe(i("#grid")),q()}).catch(n=>{console.error(n),i("#error")?.classList.remove("hidden"),i("#error-detail").textContent=String(n.message||n)})})();
